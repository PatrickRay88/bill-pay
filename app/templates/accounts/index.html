{% extends 'base.html' %}
{% block content %}
<div class="container py-3">
  
  <div class="d-flex justify-content-between align-items-center mb-3">
  <h2>Accounts</h2>
    <div class="d-flex align-items-center">
      {% if USE_PLAID %}
        {% if link_token %}
          <button class="btn btn-sm btn-success me-2 plaid-link-button">
            <i class="fa fa-link me-1"></i> {% if current_user.plaid_items|length %}Link Another Bank{% else %}Connect Bank{% endif %}
          </button>
        {% endif %}
        {% if current_user.plaid_items|length > 1 %}
          <button id="plaid-unlink-button" class="btn btn-sm btn-outline-danger me-2" data-bs-toggle="tooltip" title="Unlink ALL institutions and remove imported data">
            <i class="fa fa-unlink me-1"></i> Unlink All
          </button>
        {% elif current_user.plaid_items|length == 1 %}
          <button id="plaid-unlink-button" class="btn btn-sm btn-outline-danger me-2" data-bs-toggle="tooltip" title="Unlink institution and remove imported data">
            <i class="fa fa-unlink me-1"></i> Unlink
          </button>
        {% endif %}
        <button class="btn btn-sm btn-outline-primary me-2" id="refresh-accounts-btn">Refresh Accounts</button>
      {% endif %}
      <a href="{{ url_for('accounts.create') }}" class="btn btn-sm btn-primary me-2">
        <i class="fa fa-plus me-1"></i> New Account
      </a>
      <a href="/dashboard" class="btn btn-sm btn-secondary">Dashboard</a>
    </div>
  </div>
  {% if plaid_items %}
    <div class="mb-4">
      <h5 class="text-muted text-uppercase">Connections</h5>
      <div class="list-group">
        {% for item in plaid_items %}
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>{{ item.institution_name or 'Institution' }}</strong>
              <div class="small text-muted">Item ID: {{ item.item_id }}</div>
            </div>
            <div>
              {% if plaid_items|length > 1 %}
                <button class="btn btn-sm btn-outline-danger plaid-unlink-item-button" data-item-id="{{ item.id }}">Unlink</button>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}
  {% if account_groups %}
    {% for type, accounts in account_groups.items() %}
      <div class="mb-4">
        <h5 class="text-muted text-uppercase">{{ type }}</h5>
        <div class="list-group">
          {% for account in accounts %}
            <a href="{{ url_for('accounts.detail', account_id=account.id) }}" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
              <div>
                <strong>{{ account.name }}</strong>
                {% if account.official_name %}<div class="small text-muted">{{ account.official_name }}</div>{% endif %}
              </div>
              <div class="text-end">
                <div class="fw-bold">{{ account.current_balance or 0 | round(2) }} {{ account.iso_currency_code or 'USD' }}</div>
                {% if account.available_balance %}<div class="small text-muted">Available: {{ account.available_balance | round(2) }}</div>{% endif %}
              </div>
            </a>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="card border-0 shadow-sm mb-4">
      <div class="card-body text-center py-5">
        <div class="mb-3">
          <i class="fa fa-university fa-3x text-secondary"></i>
        </div>
        <h5 class="card-title mb-2">No Accounts Found</h5>
        {% if USE_PLAID %}
          <p class="text-muted mb-4">Connect a bank to start syncing balances and transactions.</p>
          <button class="btn btn-primary plaid-link-button">
            <i class="fa fa-link me-1"></i> Connect Your Bank
          </button>
        {% else %}
          <p class="text-muted mb-4">No accounts yet. Create one to get started.</p>
          <a href="{{ url_for('accounts.create') }}" class="btn btn-primary">
            <i class="fa fa-plus me-1"></i> Create Account
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}
  {% if link_token %}
    <div id="plaid-link-token" data-token="{{ link_token }}" class="d-none"></div>
  {% endif %}
</div>
{% endblock %}
